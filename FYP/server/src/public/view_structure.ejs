<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>View Structure</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script type="text/javascript" src="JSmol.min.js"></script>
    <script type="text/javascript" src="js/JSmolJME.js"></script>
    <script type="text/javascript" src="jsme/jsme/jsme.nocache.js"></script>
    <script type="text/javascript" src="view_structure.js"></script>

    <style>
      body{
        background-color: lightgrey;
      }

      H6{
         text-align: center 
      }
      .first {
        width: 600px;
        height: 600px;
        background-color: rgb(189, 232, 247);
        border: 1px solid black;
        position:absolute;
        top : 50px;
        left : 10px;
      }
      .second {
        width: 600px;
        height: 600px;
        background-color: lightgreen;
        border: 1px solid black;
        position:absolute;
        top : 50px;
        left : 630px;

      }
      .third {
        width: 400px;
        height: 450px;
        background-color: lightgreen;
        border: 1px solid black;
        position:absolute;
        top : 660px;
        left : 10px;
      }
      .fourth {
        width: 400px;
        height: 450px;
        background-color: lightblue;
        border: 1px solid black;
        position:absolute;
        top : 660px;
        left:420px;
      }
      .fifth{
        width: 400px;
        height: 450px;
        background-color: lightgreen;
        border: 1px solid black;
        position:absolute;
        top : 660px;
        left:830px;
      }
      #search_result {
        width:300px;
        height:100px;
        background: #82C3EE;
        overflow: auto;
        border: 1px solid black;
        width: 100%;
        aspect-ratio: 0.25;
      }
      #search_result1 {
        width:300px;
        height:100px;
        background: #82C3EE;
        overflow: auto;
        border: 1px solid black;
        width: 100%;
        aspect-ratio: 0.25;
      }
      #nav_item{
        display: inline;
      }
      #search_result a:hover {
        background-color: lightblue;
      }

      @media only screen and (max-width: 860px) {
        body{
        background-color: lightgray;
      }
      H6{
         text-align: center 
      }
        .first {
        width: 398px;
        height: 398px;
        background-color: rgb(189, 232, 247);
        border: 1px solid black;
        position:absolute;
        top : 50px;
        left : 10px;
      }
      .third {
        width: 398px;
        height: 398px;
        background-color: lightgreen;
        border: 1px solid black;
        position:absolute;
        top : 50px;
        left : 420px;

      }
      .fourth {
        width: 808px;
        height: 200px;
        background-color: lightblue;
        border: 1px solid black;
        position:absolute;
        top : 870px;
        left : 10px;
      }
      .second {
        width: 398px;
        height: 398px;
        background-color: lightgrey;
        border: 1px solid black;
        position:absolute;
        top : 460px;
        left: 10px;
      }
      .fifth{
        width: 398px;
        height: 398px;
        background-color: lightgreen;
        border: 1px solid black;
        position:absolute;
        top : 460px;
        left : 420px;
      }
      #search_result {
        width:300px;
        height:100px;
        background: #82C3EE;
        overflow: auto;
        border: 1px solid black;
        width: 100%;
        aspect-ratio: 0.25;
      }
      #search_result1 {
        width:300px;
        height:100px;
        background: #82C3EE;
        overflow: auto;
        border: 1px solid black;
        width: 100%;
        aspect-ratio: 0.25;
      }
      #nav_item{
        display: inline;
      }
      #search_result a:hover {
        background-color: lightblue;
      }
      }

    </style>
  </head>
  <body>
    
    <nav class="navbar navbar-expand navbar-light" style="background-color: #e3f2fd;">
      <div class="container-fluid">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" href="./home.html">Home Page</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="./submit_job.html">Submit Job</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="./view_structure.html">View Structure</a>
            </li>
          </ul>
      </div>
    </nav>


    <div class="first" id="first">    
      <div id="appdiv1"></div>
    </div>

    <div class="second" id="second" >
      <div id="appdiv2"></div>
    </div>

      <div class="third" id="third">
        <h6>Protien Controls</h6>
          <input type="button" id="load2model" value="Load Model">
          <input type="text" id="pdbcode_input">  
          (By PDB id)       
          <br>
          <input type="number" id="seqNum" >
          <label for="seqNumBtn">find torsion</label>
          <input type="button" id="seqNumBtn" value="Get" onclick="show_torsion()">
          <input type="button" id="seqClearBtn" value="Cear" onclick="clear_torsion()">
          <div id="search_result1"></div>
          <br>
          <input type="button" id="Rotate" value="Rotate">
          <input type="button" id="ResetView" value="Reset View">

      </div>

      <div class="fourth" id="fourth">
        <h6>Joint Controls</h6>
        <label id="left_label" for="left window">left</label>
        <input id="left window" checked="true" type="checkbox"  onclick="toggle_ctr1()">
        <label id="right_label" for="right window">right</label>
        <input id="right window" checked="flase" type="checkbox" onclick="toggle_ctr2()">
        <input type="text" id="cmd_str">
        <input type="button" id="run_cmd" value="Run" onclick="run_jmol_script()">
        <br>
        <label for="sync">Sync</label>
        <input type="checkbox" id="sync" checked="false" onchange="Sync()">
        <br>
        <label for="highlight">Highlight Loop</label>
        <input type="checkbox" id="highlight" checked="false" onchange="HighlightLoop()">
        
      </div>

      <div class="fifth" id="fifth">
        <h6>Loop Controls</h6>
        <label for="text">pdb_id</label>
        <input type="text" id="search_q" style="width: 80px;">
        Optional:
        <input type="number" id="search_beg" style="width: 50px;">
        <input type="number" id="search_end" style="width: 50px;">
        <input type="button" id="search_db_btn" value="search" onclick="Search()">
        <div id="search_result"></div>
        <br>
        <label for="show_labels">Show Phi Psi</label>
        <input type="checkbox" id="show_labels" checked="false" onchange="label_phi_psi_togg()">
        <br>
      </div>
<script>
  //import { text } from "express"

var left_crtl = true
var width_crtl = true
var current_loop='290-301'
var highted=false
var showing_labels=false


window.onload = function() { 
window.onresize = handleWindowSize;

document.getElementById("right window").checked = false;
document.getElementById("left window").checked = true;
document.getElementById("sync").checked=false;
document.getElementById("highlight").checked=false;
document.getElementById("show_labels").checked=false;

  
w =Number( window.innerWidth)

if(w<860){
 size_inital=400
 document.getElementById("left_label").textContent="up"
 document.getElementById("right_label").textContent="down"
}else{
  size_inital=598
  document.getElementById("left_label").textContent="left"
  document.getElementById("right_label").textContent="right"
}

        var JmolInfo = {
          width: size_inital,
          height: size_inital,
            //serverURL: "https://chemapps.stolaf.edu/jmol/jsmol/php/jsmol.php",
            use: "HTML5",
            script: "load=1adg"
        }
      
        document.getElementById("appdiv1").innerHTML = Jmol.getAppletHtml(
            "jmolApplet0",
            JmolInfo
        );

        var JmolInfo = {
          width: size_inital,
          height: size_inital,
          //serverURL: "https://chemapps.stolaf.edu/jmol/jsmol/php/jsmol.php",
          use: "HTML5",
          script: "load http://localhost:5123/public/OutputPDBS/PDBID_1ADG_CHAIN_A_BEG_290_END_301_PHITARGS_291_-90_292_-110_293_-64_294_-90_PSITARGS_291_122_292_-35_293_147_PHICONSTR_295_296_PSICONSTR_295_296_ITTR_10000.pdb"
      }
    
      document.getElementById("appdiv2").innerHTML = Jmol.getAppletHtml(
          "jmolApplet1",
          JmolInfo
      );

document.getElementById("third").innerHTML+=`Background color : `
document.getElementById("third").innerHTML+=Jmol.jmolRadioGroup(jmolApplet0, [["set background white", "white", true],["set background black", "black"]])
document.getElementById("third").innerHTML+=Jmol.jmolBr(jmolApplet0)
document.getElementById("third").innerHTML+=`Style : `
document.getElementById("third").innerHTML+=Jmol.jmolMenu(jmolApplet0, [
  ["select * ; spacefill only;spacefill 23%;wireframe 0.15", "ball and stick"],
  ["select * ; cartoon only",  "cartoon"],
  ["select * ; wireframe -0.25", "stick"],
  ["select * ; spacefill", "van ser walls"]
]);

document.getElementById("third").innerHTML+=Jmol.jmolBr(jmolApplet0)

document.getElementById("third").innerHTML+=`Color : `
document.getElementById("third").innerHTML+=Jmol.jmolMenu(jmolApplet0, [
  ["select * ; color cpk", "cpk"],
  ["select * ; color group",  "group"],
  ["select * ; color amino", "amino"],
  ["select * ; color structure", "structure"],
  ["select * ; color chain", "chain"]
]);

document.getElementById("third").innerHTML+=Jmol.jmolBr(jmolApplet0)

document.getElementById("third").innerHTML+=`View from : `
document.getElementById("third").innerHTML+=Jmol.jmolMenu(jmolApplet0, [
[ "reset", "Front"], 
[ "moveto 1 1 0 0 180 #Back", "Back"],
[ "moveto 1 1 0 0 -90 #Top", "Top"],
[ "moveto 1 1 0 0 90 #Bottom", "Bottom"],
[ "moveto 1 0 1 0 90 #Left", "Left"],
[ "moveto 1 0 1 0 -90 #Right", "Right"],
]);

document.getElementById("fifth").innerHTML+=`Background color : `
document.getElementById("fifth").innerHTML+=Jmol.jmolRadioGroup(jmolApplet1, [["set background white", "white", true],["set background black", "black"]])
document.getElementById("fifth").innerHTML+=Jmol.jmolBr(jmolApplet1)
document.getElementById("fifth").innerHTML+=`Anim : `
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim play", "play")
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim off", "stop")
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim off;anim rewind#;","First")
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim off;frame prev", "Prev")
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim off;frame next", "Next")
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim off;frame last", "Last")
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim off;frame all", "All")
document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1, "anim mode loop;frame 1;anim play", "loop")
document.getElementById("fifth").innerHTML+=Jmol.jmolBr(jmolApplet1)
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; cartoon only", "cartoon")
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; wireframe -0.25", "stick")
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; spacefill only;spacefill 23%;wireframe 0.15","ball&stick")
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; spacefill","Van der Waals")
document.getElementById("fifth").innerHTML+=`Style : `

document.getElementById("fifth").innerHTML+=Jmol.jmolMenu(jmolApplet1, [
  ["select * ; spacefill only;spacefill 23%;wireframe 0.15", "ball and stick"],
  ["select * ; cartoon only",  "cartoon"],
  ["select * ; wireframe -0.25", "stick"],
  ["select * ; spacefill", "van ser walls"]
]);

document.getElementById("fifth").innerHTML+=Jmol.jmolBr(jmolApplet1)
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; color cpk", "cpk color") 
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; color group", "group color")
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; color amino", "amino color")
//document.getElementById("fifth").innerHTML+=Jmol.jmolButton(jmolApplet1,"select * ; color structure", "structure color")
document.getElementById("fifth").innerHTML+=`Color : `

document.getElementById("fifth").innerHTML+=Jmol.jmolMenu(jmolApplet1, [
  ["select * ; color cpk", "cpk"],
  ["select * ; color group",  "group"],
  ["select * ; color amino", "amino"],
  ["select * ; color structure", "structure"],
  ["select * ; color chain", "chain"]
]);
document.getElementById("fifth").innerHTML+=Jmol.jmolBr(jmolApplet1)
document.getElementById("fifth").innerHTML+=`View from : `
document.getElementById("fifth").innerHTML+=Jmol.jmolMenu(jmolApplet1, [
  [ "reset", "Front"], 
  [ "moveto 1 1 0 0 180 #Back", "Back"],
  [ "moveto 1 1 0 0 -90 #Top", "Top"],
  [ "moveto 1 1 0 0 90 #Bottom", "Bottom"],
  [ "moveto 1 0 1 0 90 #Left", "Left"],
  [ "moveto 1 0 1 0 -90 #Right", "Right"],
  ]);
  
document.getElementById("Rotate").addEventListener("click", rotate_model);
document.getElementById("ResetView").addEventListener("click", reset_view)
//document.getElementById("Highlight segment").addEventListener("click", highlight)
document.getElementById("run_cmd").addEventListener("click", run_jmol_script);
document.getElementById("load2model").addEventListener("click", load_pdb);
document.getElementById("seqNumBtn").addEventListener("click", show_torsion);
document.getElementById("seqClearBtn").addEventListener("click", clear_torsion);
//document.getElementById("show_labels").addEventListener("change", label_phi_psi_togg);

//jmolApplet1.jmolSetCallback(jmolApplet1, "animframecallback", "label_phi_psi");
Jmol.script(jmolApplet1,'set animFrameCallback "label_phi_psi"')


};

//matlab -nodisplay -nojvm -r  "wrapper_loop_modeller2('1adg','LADH_loopmovement.pdb','A',290,301,[291 -90 ; 292 -110; 293 -64; 294 -90],[291 122; 292 -35; 293 147],[295 296],[294 295],10000);exit;"
    function setDefault(){
      pdbid='1adg'
      fname='LADH_loop_movement.pdb'
      chain='A'
      segb=290
      sege=301
      //291 -90 ; 292 -110; 293 -64; 294 -90]
      phitargs=[]
      phitargs.append([291,-90])
      phitargs.append([292, -110])
      phitargs.append([293, -64])
      phitargs.append([294, -90])
      //[291 122; 292 -35; 293 147]
      psitargs=[]
      psitargs.append([291, 122])
      psitargs.append([292, -35])
      psitargs.append([293 , 147])
      //[295 296]
      phiconstr=[295,  296]
      //[294 295]
      psiconstr=[294 , 295]

      itter=10000

      document.getElementById("pdbcode_input").value = pdbid
    }

    function load_pdb() {
        console.log("clicked" + jmolApplet0);
        var pdbCode = document.getElementById("pdbcode_input").value;
        Jmol.script(jmolApplet0, "load=" + pdbCode);
    }

    function rotate_model() {
      console.log("called rotate")
        Jmol.script(jmolApplet0, "rotate y 30");
    }

    function reset_view() {
        Jmol.script(jmolApplet0, "reset");
    }

    function highlight() {
        var start = document.getElementById("start").value;
        var end = document.getElementById("end").value;
        Jmol.script(
            jmolApplet0,
            "select " + start + "-" + end + "; color orange"
        );
    }


function run_jmol_script() {
        console.log("run jmol cmd")
        var cmd = document.getElementById("cmd_str").value;
        console.log("cmd" +cmd)
        if(left_crtl){
        Jmol.script(jmolApplet0, cmd);
        }else{
        Jmol.script(jmolApplet1, cmd);
        }
    }


function Sync(){
  if (document.getElementById("sync").checked == true){
    Jmol.script(jmolApplet0,'sync * on; sync * "set syncMouse true"')
  }else{
    Jmol.script(jmolApplet0,'sync * off')
  }
}

async function Load(){
  val = document.getElementById("load").value
  console.log(val)
  data = await getPdb(val)
  console.log(data)
  Jmol.script(jmolApplet0, "load "+data.redirectUrl)
}

var re = /BEG_\d+_END_\d+/;

var re1 = /seq \d+/;

async function load_from_server(event){
  console.log(event)
  parent=event.target.parentNode
  console.log(parent)
  console.log(parent.querySelectorAll('p'))
  
  fname=parent.querySelectorAll('p')[0].innerText

  //set the current loops begin / end string 
  result = fname.match(re)[0]
  result2 = result.replace('BEG','')
  result3 = result2.replace('END','')
  result4 = result3.replace('_','')
  result5 = result4.replace('__','-')
  result6 = result5.trim()
  current_loop=result6

  
  console.log(parent.querySelectorAll('p')[0].innerText)
  console.log(parent.querySelectorAll('p')[0].innerHTML)
  exsists=await check_file_exsists(fname)
  console.log("exsists")
  console.log(exsists)
  if(exsists == false){
    alert("server err that file doesn't exsist but is reference in the database")
  }else{
    Jmol.script(jmolApplet1, "load "+exsists)
  }
}
async function check_file_exsists(fname_){
  console.log("searching for "+fname_ )
  let res_= await fetch("http://localhost:5123/api/v1/pdbs/1", {
    method : 'POST',
    headers : {
      'Content-Type' : 'application/json'
    },
    body : JSON.stringify({
      fname : fname_
    })
  }).then(res_ => res_.text())
  return res_
}

async function Search(){
  query=document.getElementById("search_q").value
  q_beg=document.getElementById("search_beg").value
  q_end=document.getElementById("search_end").value
  console.log(q_end)
  query="http://localhost:5123/api/v1/pdbs/?pdbid="+query.toUpperCase()
  fetch(query)
  .then(response => response.json())
  .then(data => {
    console.log(data);
    //document.getElementById("search_result").value = data
    resultDiv=document.getElementById("search_result")
    resultDiv.innerHTML=''
    
    for(var i=0;i<data.length;i++){
      innerDiv= document.createElement('div');
      console.log(data[i])
      a = document.createElement('a');
      p = document.createElement('p');
      p.style.display='none'
      p.textContent=data[i].fname  
      a.textContent = "Beg: "+ data[i].segbeg + " End: " + data[i].segend + " Targ φ: "+ data[i].target_residues_phi + " Targ ψ : "+ data[i].target_residues_psi + " Cnstr φ: "+ data[i].constr_residues_phi+ + " Cnstr ψ: "+ data[i].constr_residues_psi   
      a.onclick = load_from_server
      innerDiv.appendChild(a)
      innerDiv.appendChild(p)
      resultDiv.appendChild(innerDiv)
      resultDiv.append(document.createElement('br'))
    }
  })
  .catch(error => {
    console.error(error);
  });

}

function toggle_ctr1(){
   
      left_crtl = true
      document.getElementById("right window").checked = false;
      document.getElementById("left window").checked = true;
    
}
function toggle_ctr2(){
   
    left_crtl = false
    document.getElementById("left window").checked = false;
    document.getElementById("right window").checked = true;

}

function handleWindowSize(){
  
  w =Number( window.innerWidth)
  if(w<880){
    jmolApplet0._resizeApplet(400,400)
    jmolApplet1._resizeApplet(400,400)
    document.getElementById("left_label").textContent="up"
    document.getElementById("right_label").textContent="down"
  }else{
    jmolApplet0._resizeApplet(598,598)
    jmolApplet1._resizeApplet(598,598)
    document.getElementById("left_label").textContent="left"
    document.getElementById("right_label").textContent="right"
  }
}

function HighlightLoop(){
  if(!highted){
    highted=true
  Jmol.script(
    jmolApplet0,
    "select " +current_loop+ "; color lawngreen"
);
  }else{
    highted=false
    Jmol.script(
      jmolApplet0,
      "select * ; color cpk"
  );
  }

}

function get_torsion_angle(seqNum){

  phi= Jmol.getPropertyAsArray(jmolApplet0, "polymerInfo").models[0].polymers[0].monomers[seqNum].phi
  psi= Jmol.getPropertyAsArray(jmolApplet0, "polymerInfo").models[0].polymers[0].monomers[seqNum].psi
  //console.log("phi " +phi + " psi " + psi)
  return {"phi" : phi , "psi": psi}
}
function show_torsion(){
  num=document.getElementById('seqNum').value
  tors = get_torsion_angle(num)
  console.log(psi)
  outDiv=document.getElementById('search_result1')
  p = document.createElement('p');
  p.innerText=`seq ${num}, φ ${tors.phi.toFixed(8)}, ψ ${tors.psi.toFixed(8)}`
  p.onclick = hilight_sgl
  outDiv.appendChild(p)

}
function clear_torsion(){
  document.getElementById('search_result1').innerHTML=''
}
function hilight_sgl(event){
  text=event.target.innerText.match(re1)[0]
  text=text.replace("seq", "")
  text=text.trim()
  //console.log(text)
  Jmol.script(jmolApplet0, "select "+text+ "; color lawngreen")
}



function label_phi_psi_togg(){
  if(showing_labels){
    showing_labels=false
    document.getElementById("show_labels").checked = false;

    //Jmol.script(jmolApplet1,'set animFrameCallback "None"')
   // Jmol.script(jmolApplet1,`select ${start}-${end}.ca ; label ""`)

  }else{
    showing_labels=true
    document.getElementById("show_labels").checked = true;
    Jmol.script(jmolApplet1,'set animFrameCallback "label_phi_psi"')
  }
  console.log(showing_labels)
}

function label_phi_psi(){
  if (showing_labels){
  loop=current_loop.split("-")
  start=parseInt(loop[0])
  end=parseInt(loop[1])
  Jmol.script(jmolApplet1,`select ${start}-${end}.ca ; label φ %.0[phi] ψ %.0[psi]`)
  //for(var i =start; i< end;i++ ){
  //  Jmol.script(jmolApplet1,  ` select ${i} ; label "YO"`)
 // }
}else{
  Jmol.script(jmolApplet1,`select ${start}-${end}.ca ; label ""`)
  
}
  /*
  Jmol.script(jmolApplet1, 
 `select protein;
  measure phiPsiSelected;
  for (var i = 1; i <= _atomCount; i++) {
    if (_atomName[i] == "CA") {
      label %a "Phi:%.1f\nPsi:%.1f" %({phiPsiSelected[i-1][0]}, {phiPsiSelected[i-1][1]})
    }
  }`)
  */

}
</script>
  </body>
</html>